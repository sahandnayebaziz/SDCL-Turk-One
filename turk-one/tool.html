<template name="tool">

	<div class="container-fluid container-tool">
		<div class="row">
			<div class="col-md-12 col-lg-4 bottom-buffer-50 md-fixed">
				{{#with decisionPoint}}
					{{>decisionPointInformationPanel}}
				{{/with}}
			</div>
			<div class="col-md-12 col-lg-8 col-lg-offset-4 bottom-buffer-100">
				<div class="row">
					<div class="col-lg-1 col-md-12">
						<div id="toolbarContainer" class="md-fixed">
							<span class="buttonToolbar buttonColor" id="buttonBlack" data-color="#414141"></span>
							<!--<span class="buttonColor" id="buttonWhite" data-color="#FFFFFF"></span>-->
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonBlue" data-color="#80D4FC"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonGreen" data-color="#A1F5AA" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Select the colour of your brush"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonRed" data-color="#F78479"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonYellow" data-color="#FBDE9E"></span>
							<img src="/type.png" class="buttonToolbar deselectedTool" id="buttonText" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Add text to your sketch">
							<span class="buttonToolbar deselectedTool" id="buttonMove" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Sketch object selector and mover"></span>
							<span class="buttonToolbar deselectedTool" id="buttonEraser" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Eraser"></span>
							<img src="/un-do.png" class="buttonToolbar deselectedTool buttonHistory" id="buttonUndo" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Undo">
							<img src="/re-do.png" class="buttonToolbar deselectedTool buttonHistory" id="buttonRedo" data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="Redo">
						</div>
					</div>

					<style>
						@media screen and (max-width: 62em) {
							#toolbarContainer {
								position: fixed;
								bottom: 50px;
								left: 50%;
								margin-left: -200px;
								display: block;
								min-width: 340px;
								height: 46px;
								padding: 10px 9px 9px 17px;
								background: #CECECE;
								box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.24);
								border-radius: 6px;
								z-index: 2;
							}

							.buttonToolbar {
								display: block;
								float: left;
								clear: none;
								margin: 0px 8px 0px 0px;
								height: auto;
								width: 25px;
							}

						  #buttonText {
							  margin-left: 24px!IMPORTANT;
						  }

						  #buttonEraser {
							  margin-right: 24px!IMPORTANT;
						  }

						  #buttonRedo, #buttonUndo {
							  margin-top: 5px;
						  }
						}

						@media screen and (min-width: 62em) {
							#toolbarContainer {
								margin-right: 15px;
								margin-top: 100px;
								background: #CECECE;
								box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.14);
								border-radius: 6px;
								padding-top: 17px;
								padding-bottom: 9px;
								min-width: 50px;
							}

							.buttonToolbar {
								height: auto;
								width: 25px;
								display: block;
								margin-left: auto;
								margin-right: auto;
								margin-bottom: 8px;
							}

							#buttonText {
								margin-top: 24px;
							}

							#buttonMove {
								background-image: url("/controls.png");
								height: 28px;
								width: 28px;
							}

							#buttonEraser {
								background-image: url("/eraser.png");
								height: 25px;
								margin-bottom: 24px;
							}
						}


						.buttonHistory {
							padding-bottom: 3px;
							padding-top: 3px;
						}

						.deselectedTool {
							opacity: 0.4;
						}
						
						.deselectedTool:hover {
							opacity: 0.8;
						}

						.buttonColor {
							border-radius: 50px;
							height: 25px;
						}

						#buttonBlack {
							background: #414141;
							border: 3px solid #000000;
						}

						#buttonWhite {
							background: #FFFFFF;
							border: 3px solid #BDBDBD;
						}

						#buttonBlue {
							background: #80D4FC;
							border: 3px solid #4B95B4;
						}

						#buttonGreen {
							background: #A1F5AA;
							border: 3px solid #6AB373;
						}

						#buttonRed {
							background: #F78479;
							border: 3px solid #C76A61;
						}

						#buttonYellow {
							background: #FBDE9E;
							border: 3px solid #E9BB35;
						}

						#buttonMove {
							background-image: url("/controls.png");
							height: 28px;
							width: 28px;
						}

						#buttonEraser {
							background-image: url("/eraser.png");
							height: 25px;
						}
						
						#buttonText {
							height: 25px;
						}

						.selectedTool {
							opacity: 1!IMPORTANT;
						}
						
						
					</style>
					<script>
						// set up for canvases
						// setting the default number of canvases to show
						Session.set("numberOfCanvasesToShow", 5);

						// this array will hold references to each Fabric canvas instance, and is looped through in the below toolbar
						// actions to 'broadcast' the toolbar selects across the canvases
						canvases = [];

						// focusedCanvas
						canvasWithFocus = null;

						// used for maintaing sanity while drawing straight or free-form lines
						isDrawing = false;

						// state object for undo/redo stacks
						canvasHistory = {};

						// Set Black as default color in toolbar (set for each canvas at initialization in tool.html
						Session.set("currentColor", "#414141");
						$("#buttonBlack").addClass("selectedTool");

						// setting toolbar active tool
						function setSelectedTool(tool) {
							$(".selectedTool").removeClass("selectedTool").addClass("deselectedTool");
							$(tool).addClass("selectedTool");

							if ($(tool).attr("id") != "buttonEraser") {
								disableEraser();
							}
						}

						// toolbar color clicked
						$(".buttonColor").click(function () {
							setSelectedTool(this);
							var colorChosen = this.getAttribute("data-color");

							Session.set("currentColor", colorChosen);
							$.each(canvases, function() {
								this.freeDrawingBrush.color = colorChosen;
								this.isDrawingMode = true;
							});
						});

						// toolbar eraser clicked
						$("#buttonEraser").click(function () {
							setSelectedTool(this);
							enableEraser();
						});

						function disableEraser() {
							console.log("disabling eraser");

							$.each(canvases, function() {
								this.off("mouse:down");
							});
						}

						function enableEraser() {
							$.each(canvases, function() {
								var canvas = this;

								canvas.isDrawingMode = false;
								canvas.on("mouse:down", function (e) {
									if (this.getActiveGroup()) {
										recordingStates = false;
										canvas.getActiveGroup().forEachObject(function (a) {
											canvas.remove(a);
										});
										canvas.discardActiveGroup();
										recordingStates = true;
									} else {
										canvas.remove(canvas.getActiveObject());
									}
									canvas.renderAll();
								});
							});
						}

						// toolbar move controls clicked
						$("#buttonMove").click(function() {
							setSelectedTool(this);

							$.each(canvases, function() {
								this.isDrawingMode = false;
							})
						});

						// text button clicked
						$("#buttonText").click(function() {

							setSelectedTool(this);
							$.each(canvases, function() {
								this.isDrawingMode = false;
							});

							canvasWithFocus.on("mouse:down", function (e) {
								var pointer = canvasWithFocus.getPointer(event.e);

								canvasWithFocus.add(new fabric.IText('Enter Text', {
									fontFamily: 'times black',
									left: pointer.x,
									top: pointer.y,
									fontSize: 16
								}));

								var textObject = canvasWithFocus.item(canvasWithFocus.getObjects().length - 1);
								canvasWithFocus.setActiveObject(textObject);

								//textObject.enterEditing(); this line was temporarily removed because it was causing the window to scroll

								textObject.selectAll();
								$.each(canvases, function() {
									this.off("mouse:down");
								});

								setSelectedTool("#buttonMove");
							});
						});

						// UNDO AND REDO
						$("#buttonUndo").click(function () {

							var index = canvasWithFocus.CDIndex;
							var back = canvasHistory[index].backStates;

							if (back.length > 1) {
								canvasHistory[index].recording = false;
								var fromState = back.pop();
								canvasHistory[index].forwardStates.push(fromState);
								var toState = back[back.length - 1];
								canvasWithFocus.loadFromJSON(toState);
								canvasWithFocus.renderAll();
								canvasHistory[index].recording = true;
							}
						});

						$("#buttonRedo").click(function () {
							var index = canvasWithFocus.CDIndex;
							var forward = canvasHistory[index].forwardStates;

							if (forward.length > 0) {
								canvasHistory[index].recording = false;
								var toState = forward.pop();
								canvasHistory[index].backStates.push(toState);

								canvasWithFocus.loadFromJSON(toState);
								canvasWithFocus.renderAll();
								canvasHistory[index].recording = true;
							}
						});

						// drawing straight lines when pressing shift
						Mousetrap.bind('shift', function () {

							var line, isDown;

							canvasWithFocus.isDrawingMode = false;
							canvasWithFocus.selection = false;
							canvasWithFocus.forEachObject(function(o) {
								o.selectable = false;
							});

							canvasWithFocus.on('mouse:down', function(o){
								isDown = true;
								isDrawing = true;
								var pointer = canvasWithFocus.getPointer(o.e);
								var points = [ pointer.x, pointer.y, pointer.x, pointer.y ];
								line = new fabric.Line(points, {
									strokeWidth: 5,
									fill: 'black',
									stroke: 'black',
									originX: 'center',
									originY: 'center',
								});
								canvasWithFocus.add(line);
							});

							canvasWithFocus.on('mouse:move', function(o){
								if (!isDown) return;
								var pointer = canvasWithFocus.getPointer(o.e);
								line.set({ x2: pointer.x, y2: pointer.y });
								canvasWithFocus.renderAll();
								line.selectable = true;
							});

							canvasWithFocus.on('mouse:up', function(o){
								isDown = false;
								isDrawing = false;
								//canvasWithFocus.remove(canvasWithFocus.item(canvasWithFocus.getObjects().length - 1));
							});
						}, 'keydown');

						Mousetrap.bind('shift', function () {
							if (!isDrawing) {
								c = canvasWithFocus;
								c.off('mouse:down');
								c.off('mouse:move');
								c.off('mouse:up');

								c.isDrawingMode = false;
								c.selection = true;
								c.forEachObject(function(o) {
									o.selectable = true;
								});
							}
						}, 'keyup');

						// enables the "submit" button in the quit survey once a reason is selected
						$('input:radio').change(
							function(){
								$("#quitSubmit").removeClass("disabled");
								$("#quitSubmit").prop("disabled",false);
							}
						);


						// guessing focus
						function findFocus() {

							var scrollPosition = $(window).scrollTop();
							var focusDistance = 9999;
							var focusGuess = null;
							var focusGuessIndex = 0;

							$.each($(".canvasContainer"), function() {
								var positionAtTopOfCanvas = $(this).offset().top;
								var distanceFromScrollPosition = Math.abs(scrollPosition - positionAtTopOfCanvas);
								if ((scrollPosition < positionAtTopOfCanvas + 250) && (distanceFromScrollPosition < focusDistance)) {
									focusDistance = distanceFromScrollPosition;
									focusGuess = this;
								}
							});

							$.each($(".canvasContainer"), function() {
								if (this == focusGuess) {
									$(this).removeClass("unfocusedCanvas");
									$(this).addClass("focusedCanvas");
									focusGuessIndex = parseInt($(this).attr("data-CDIndex"));
								} else {
									$(this).removeClass("focusedCanvas");
									$(this).addClass("unfocusedCanvas");
								}
							});

							$.each(canvases, function () {
								if (this.CDIndex == focusGuessIndex) {
									canvasWithFocus = this;
								}
							});
						}

						// attach focus guessing to window scrolling
						$(window).scroll(findFocus);

						// provide method for forcing focus
						forceFocus = function(index) {

							$.each($(".canvasContainer"), function() {
								if (parseInt($(this).attr("data-cdindex")) == index) {
									$(this).removeClass("unfocusedCanvas");
									$(this).addClass("focusedCanvas");
								} else {
									$(this).removeClass("focusedCanvas");
									$(this).addClass("unfocusedCanvas");
								}
							});

							$.each(canvases, function () {
								if (this.CDIndex == index) {
									canvasWithFocus = this;
								}
							});

						};

						$("#col-sketch").on("mousedown", ".canvasContainer", function () {
							var index = parseInt($(this).attr("data-cdindex"));
							forceFocus(index);
						});

					</script>

					<div class="col-lg-10 animated fadeIn" id="col-sketch">
						{{#each solutions}}
							<div class="canvasContainer" data-CDIndex="{{canvasNumber}}">
								<canvas class="canvas-sketch" id="canvas-{{canvasNumber}}" data-placement="top" href="#" data-trigger="manual" data-toggle="tooltip" title="This is one of your five sketch canvases to use for drawing out your solutions"></canvas>
								<div class="canvas-forms">
									<div class="row">
										<div class="col-md-12"><input id="name-{{canvasNumber}}" type="text" placeholder="Name this solution" class="form-control form-transparent form-name"
                                                                      data-placement="left" href="#" data-trigger="manual" data-toggle="tooltip" title="Name your solution here"></div>
									</div>
									<div class="row">
										<div class="col-md-12">
											<textarea id="explain-{{canvasNumber}}" placeholder="Explain this solution" class="form-transparent form-control form-description"
                                                      data-placement="left" href="#" data-trigger="manual" data-toggle="tooltip" title="Explain your solution here"></textarea>
										</div>
									</div>
								</div>
							</div>

							<script>
								console.log("throwing down");
								// format new canvas element in HTML
								var idForNewCanvas = "canvas-" + {{canvasNumber}};
								var element = $("#" + idForNewCanvas);
								var canvasHeightShouldBe = 500;
								var canvasWidthShouldBe = $("#col-sketch").width();
								$(element).attr({"height":canvasHeightShouldBe, "width":canvasWidthShouldBe});

								// initialize Fabric canvas element
								var canvas = new fabric.Canvas(idForNewCanvas);
								canvas.CDIndex = {{canvasNumber}};

								// add references to this canvas
								canvases.push(canvas);
								canvasHistory[canvas.CDIndex] = {backStates: [], forwardStates: [], recording: true};


								// set canvas defaults
								canvas.isDrawingMode = true;
								canvas.freeDrawingBrush.width = 5;
								canvas.freeDrawingBrush.color = Session.get("currentColor");
								canvas.setBackgroundColor("white").renderAll();
							</script>

							{{#if state}}
								<script>
									canvas.loadFromJSON({{state}});
									canvas.renderAll();
									// code from save self
									var index = canvas.CDIndex;
									var recording = canvasHistory[index].recording;

									if (recording) {
										if (canvasHistory[index].backStates.length == 50) {
											canvasHistory[index].backStates.shift();
										}

										canvasHistory[index].forwardStates = [];
										canvasHistory[index].backStates.push(JSON.stringify(canvas));
									}
								</script>
							{{/if}}

							<script>

								// create connections to name and explain values
								var nameForThisCanvas = $("#name-" + {{canvasNumber}});
								var explainForThisCanvas = $("#explain-" + {{canvasNumber}});

								// create initial save to mongoDB and stash the objectID for each canvas
								// so we can make updates in the future
//								createPersistSelf = (function (canvas) {
//									return function() {
//										if (Session.get("insertedSolutionFor" + canvas.CDIndex)) {
//
//										} else {
//											Solutions.insert({
//												workerId: Session.get("ticket"),
//												state: JSON.stringify(canvas),
//												createdAt: new Date(),
//												dateUpdated: new Date(),
//												canvasNumber: canvas.CDIndex
//											}, function(error, id) {
//												Session.setPersistent("objectId" + canvas.CDIndex, id);
//												Session.setPersistent("insertedSolutionFor" + canvas.CDIndex, "true");
//											});
//										}
//									}
//								})(canvas);
//								createPersistSelf();

								saveSelf = (function (canvas, name, explain) {
									return function() {
										var index = canvas.CDIndex;
										var recording = canvasHistory[index].recording;

										if (recording) {
											if (canvasHistory[index].backStates.length == 50) {
												canvasHistory[index].backStates.shift();
											}

											canvasHistory[index].forwardStates = [];
											canvasHistory[index].backStates.push(JSON.stringify(canvas));
										}

										Solutions.update(Session.get("objectId" + canvas.CDIndex), {
											$set: {
												state: JSON.stringify(canvas),
												dateUpdated: new Date(),
												name: name.val(),
												explain: explain.val()
											}
										}, function(error, number) {
											if (!error) {
											}
										});
									}
								})(canvas, nameForThisCanvas, explainForThisCanvas);

								// event hooks
								canvas.on('object:added', saveSelf);
								canvas.on('object:modified', saveSelf);
								canvas.on('object:removed', saveSelf);

								// initial save state
								saveSelf();

								// force focus on the first canvas when all are initialized (this runs every time, but haven't found a
								// lighter way to do this yet
								forceFocus(1);

							</script>
						{{/each}}
					</div>
				</div>
				<!--{{#if shouldShowAddCanvasButton}}-->
					<!--<span class="col-sm-12 text-center animated fadeInUp">-->
						<!--<button type="button" class="btn btn-primary btn-continue addCanvas top-buffer-25"><span class="small">ADD SOLUTION</span></button>-->
					<!--</span>-->
				<!--{{else}}-->
					<!--<span class="col-sm-12 text-center animated fadeInUp">-->
						<!--<button type="button" class="btn btn-primary btn-continue disabled top-buffer-25"><span class="small">MAX 5 solutions added!</span></button>-->
					<!--</span>-->
				<!--{{/if}}-->
			</div>
		</div>
	</div>

	<div class="modal fade" id="finishModal" tabindex="-1" role="dialog" aria-labelledby="Finish confirmation" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Are you sure you're ready to finish?</h4>
				</div>
				<div class="modal-body">
					<p class="modal-text">If you are finished, you will now have a chance to review your sketches and select which
						you would like to submit.</p>
					<p><strong class="text-danger">Once you click "review and finish", you will not have a chance to return and continue
					sketching your solutions.</strong></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-success" id="finishConfirm">Review and finish</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="quitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Are you sure you want to quit this HIT?</h4>
				</div>
				<div class="modal-body">
					<form id="quitForm" class="top-buffer-25">
						<label>Why are you quitting this task?</label>
						<!--- The task is to easy-->
						<!--- The task is to hard-->
						<!--- It is not clear to me what I need to do-->
						<!--- The tool does not work like I would expect-->
						<!--- Other, (provide textfield)-->
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="too easy">
								The task is too easy
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="too hard">
								The task is too hard
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="not clear">
								It is not clear to me what I need to do
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="tool doesn't work">
								The tool does not work like I would expect
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="Other">
								Other (explained below)
							</label>
						</div>
						<fieldset class="form-group top-buffer-50">
							<label for="quitText">Do you have any feedback to improve this HIT?</label>
							<textarea class="form-control" id="quitText" rows="3"></textarea>
						</fieldset>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-danger disabled" disabled="true" id="quitSubmit">Quit this HIT</button>
				</div>
			</form>
				</div>
			</div>
		</div>
	</div>

	<style>
		.container-tool {
			margin-top: 60px;
		}

		.canvasContainer {
			opacity: 0.4;
			transition: opacity .13s ease-out;
		}
		
		.canvasContainer.focusedCanvas {
			opacity: 1;
		}

		canvas.canvas-sketch {
			display: block;
			box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.04);
			border-radius: 5px;
		}

		.form-transparent {
			background-color: transparent;
			border: none;
			outline: none;
		}

		.canvas-forms {
			margin-top: 25px;
		}

		.form-name {
			font-size: 20px;
		}

		.form-description {
			font-size: 15px;
			line-height: 20px;
			height: 80px;
			resize: none;
		}
	</style>
</template>

<template name="decisionPointInformationPanel">
	<div class="row">
		<div class="col-md-12 col-lg-10 col-lg-offset-1">
            <div class="pull-left row">
                <p class="lead">
                    MTurk CrowdDesign HIT<br><br>
                </p>
                <h4 href="#" data-trigger="manual" data-toggle="tooltip" title="This is the decision point you have to design">{{name}}<br></h4>
                <p>{{description}}</p>
                <p><span class="text-muted"><strong data-placement="right" href="#" data-trigger="manual" data-toggle="tooltip" title="These are the requirements for your solutions">REQUIREMENTS</strong></span><br>
                    {{requirements}}</p>
            </div>
            <div class="row">
                <!--modal for review and finish -->
                <div class="pull-left top-buffer-50" data-placement="bottom" href="#" data-trigger="manual" data-toggle="tooltip" title="When you have designed all your solutions click here to review and submit them">
                    <a data-toggle="modal" data-target="#finishModal" class="btn btn-success btn-continue">REVIEW AND FINISH</a>
                </div>

                <!--modal for this button placed below-->
                <div class="pull-right top-buffer-50" data-placement="bottom" href="#" data-trigger="manual" data-toggle="tooltip" title="Please click here if you want to quit">
                    <button class="btn btn-danger btn-continue" data-toggle="modal" data-target="#quitModal">QUIT</button>
                </div>

                <div class="col-xs-3 col-centered top-buffer-50" data-placement="top" href="#" data-trigger="manual" data-toggle="tooltip" title="Toggle tips On/Off">
                <button class="btn tooltips-toggle" id="tips-toggle">TOGGLE TIPS</button>
                </div>
            </div>
		</div>
	</div>

    <script>
        $("#tips-toggle").click(function() {
            $('[data-toggle="tooltip"]').tooltip('toggle');
            console.log("pressed the motha fing button bitch!")
        });
    </script>

    <style>
        .tooltip-inner {
            max-width: 300px;
            /* If max-width does not work, try using width instead */
            /*width: 350px;*/
        }
    </style>

</template>