<template name="tool">
	<div class="container-fluid container-tool">
		<div class="row">
			<div class="col-md-12 col-lg-4 bottom-buffer-50 md-fixed">
				{{#with workerTicket}}
					<script>
						console.log({{_id}});
						Session.set("ticketId", {{_id}});
					</script>
				{{/with}}

				{{#with decisionPoint}}
					{{>decisionPointInformationPanel}}
				{{/with}}
			</div>
			<div class="col-md-12 col-lg-8 col-lg-offset-4 bottom-buffer-100">
				<div class="row">
					<div class="col-lg-1 col-md-12">
						<div id="toolbarContainer" class="md-fixed">
							<span class="buttonToolbar buttonColor" id="buttonBlack" data-color="#414141"></span>
							<!--<span class="buttonColor" id="buttonWhite" data-color="#FFFFFF"></span>-->
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonBlue" data-color="#80D4FC"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonGreen" data-color="#A1F5AA"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonOrange" data-color="#F7B779"></span>
							<span class="buttonToolbar deselectedTool buttonColor" id="buttonYellow" data-color="#FBDE9E"></span>
							<img src="/type.png" class="buttonToolbar deselectedTool" id="buttonText">
							<span class="buttonToolbar deselectedTool" id="buttonMove"></span>
							<span class="buttonToolbar deselectedTool" id="buttonEraser"></span>
							<img src="/un-do.png" class="buttonToolbar deselectedTool buttonHistory" id="buttonUndo">
							<img src="/re-do.png" class="buttonToolbar deselectedTool buttonHistory" id="buttonRedo">
						</div>
					</div>

					<style>
						@media screen and (max-width: 62em) {
							#toolbarContainer {
								position: fixed;
								bottom: 50px;
								left: 50%;
								margin-left: -200px;
								display: block;
								min-width: 340px;
								height: 46px;
								padding: 10px 9px 9px 17px;
								background: #CECECE;
								box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.24);
								border-radius: 6px;
								z-index: 2;
							}

							.buttonToolbar {
								display: block;
								float: left;
								clear: none;
								margin: 0px 8px 0px 0px;
								height: auto;
								width: 25px;
							}

						  #buttonText {
							  margin-left: 24px!IMPORTANT;
						  }

						  #buttonEraser {
							  margin-right: 24px!IMPORTANT;
						  }

						  #buttonRedo, #buttonUndo {
							  margin-top: 5px;
						  }
						}

						@media screen and (min-width: 62em) {
							#toolbarContainer {
								margin-right: 15px;
								margin-top: 100px;
								background: #CECECE;
								box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.14);
								border-radius: 6px;
								padding-top: 17px;
								padding-bottom: 9px;
								min-width: 50px;
							}

							.buttonToolbar {
								height: auto;
								width: 25px;
								display: block;
								margin-left: auto;
								margin-right: auto;
								margin-bottom: 8px;
							}

							#buttonText {
								margin-top: 24px;
							}

							#buttonMove {
								background-image: url("/controls.png");
								height: 28px;
								width: 28px;
							}

							#buttonEraser {
								background-image: url("/eraser.png");
								height: 25px;
								margin-bottom: 24px;
							}
						}


						.buttonHistory {
							padding-bottom: 3px;
							padding-top: 3px;
						}

						.deselectedTool {
							opacity: 0.4;
						}
						
						.deselectedTool:hover {
							opacity: 0.8;
						}

						.buttonColor {
							border-radius: 50px;
							height: 25px;
						}

						#buttonBlack {
							background: #414141;
							border: 3px solid #000000;
						}

						#buttonWhite {
							background: #FFFFFF;
							border: 3px solid #BDBDBD;
						}

						#buttonBlue {
							background: #80D4FC;
							border: 3px solid #4B95B4;
						}

						#buttonGreen {
							background: #A1F5AA;
							border: 3px solid #6AB373;
						}

						#buttonOrange {
							background: #F7B779;
							border: 3px solid #DE8A6E;
						}

						#buttonYellow {
							background: #FBDE9E;
							border: 3px solid #E9BB35;
						}

						#buttonMove {
							background-image: url("/controls.png");
							height: 28px;
							width: 28px;
						}

						#buttonEraser {
							background-image: url("/eraser.png");
							height: 25px;
						}
						
						#buttonText {
							height: 25px;
						}

						.selectedTool {
							opacity: 1!IMPORTANT;
						}
						
						
					</style>
					<div class="col-lg-10 animated fadeIn" id="col-sketch">
						{{#each numberOfCanvasesToShow}}
							<div class="canvasContainer" data-CDIndex="{{this}}">
								<canvas class="canvas-sketch" id="canvas-{{this}}"></canvas>
								<div class="canvas-forms">
									<div class="row">
										<div class="col-md-12"><input id="name-{{this}}" type="text" placeholder="Name this solution" class="form-control form-transparent form-name"></div>
									</div>
									<div class="row">
										<div class="col-md-12">
											<textarea id="explain-{{this}}" placeholder="Explain this solution" class="form-transparent form-control form-description"></textarea>
										</div>
									</div>
								</div>
							</div>
							<script>
								// format new canvas element in HTML
								var idForNewCanvas = "canvas-" + {{this}};
								var element = $("#" + idForNewCanvas);
								var canvasHeightShouldBe = 500;
								var canvasWidthShouldBe = $("#col-sketch").width();
								$(element).attr({"height":canvasHeightShouldBe, "width":canvasWidthShouldBe});

								// initialize Fabric canvas element
								var canvas = new fabric.Canvas(idForNewCanvas);
								canvas.CDIndex = {{this}};

								// add references to this canvas
								canvases.push(canvas);
								canvasHistory[canvas.CDIndex] = {backStates: [], forwardStates: [], recording: true};

								// force focus on the first canvas when all are initialized (this runs every time, but haven't found a
								// lighter way to do this yet
								forceFocus(1);

								// set canvas defaults
								canvas.isDrawingMode = true;
								canvas.freeDrawingBrush.width = 5;
								canvas.freeDrawingBrush.color = Session.get("currentColor");
								canvas.setBackgroundColor("white").renderAll();

								// create connections to name and explain values
								var nameForThisCanvas = $("#name-" + {{this}});
								var explainForThisCanvas = $("#explain-" + {{this}});


//								function saveLatestWork(number, canvas, name, explain) {
//									var stateOfCanvas = JSON.stringify(canvas);
//
//									Solutions.upsert(Session.get("ticketId") + number, {
//										workerId: Session.get("ticketId"),
//										state: stateOfCanvas,
//										dateUpdated: new Date(),
//										name: name.val(),
//										explain: explain.val()
//									});
//
//									lastCanvas = canvas;
//								}

								// method definitions
								saveSelf = (function (canvas) {
									return function() {
										var index = canvas.CDIndex;
										var recording = canvasHistory[index].recording;

										if (recording) {
											if (canvasHistory[index].backStates.length == 50) {
												canvasHistory[index].backStates.shift();
											}

											canvasHistory[index].forwardStates = []
											canvasHistory[index].backStates.push(JSON.stringify(canvas));
										}
									}
								})(canvas);

								// event hooks
								canvas.on('object:added', saveSelf);
								canvas.on('object:modified', saveSelf);
								canvas.on('object:removed', saveSelf);

								// initial save state
								saveSelf();

							</script>
						{{/each}}
					</div>
				</div>
				<!--{{#if shouldShowAddCanvasButton}}-->
					<!--<span class="col-sm-12 text-center animated fadeInUp">-->
						<!--<button type="button" class="btn btn-primary btn-continue addCanvas top-buffer-25"><span class="small">ADD SOLUTION</span></button>-->
					<!--</span>-->
				<!--{{else}}-->
					<!--<span class="col-sm-12 text-center animated fadeInUp">-->
						<!--<button type="button" class="btn btn-primary btn-continue disabled top-buffer-25"><span class="small">MAX 5 solutions added!</span></button>-->
					<!--</span>-->
				<!--{{/if}}-->
			</div>
		</div>
	</div>

	<div class="modal fade" id="finishModal" tabindex="-1" role="dialog" aria-labelledby="Finish confirmation" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Are you sure you're ready to finish?</h4>
				</div>
				<div class="modal-body">
					<p class="modal-text">If you are finished, you will now have a chance to review your sketches and select which
						you would like to submit.</p>
					<p><strong>Once you click "review and finish", you will not have a chance to return and continue
					sketching your solutions.</strong></p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn btn-success" id="finishConfirm">Review and finish</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="quitModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">Are you sure you want to quit this HIT?</h4>
				</div>
				<div class="modal-body">
					<form id="quitForm" class="top-buffer-25">
						<label>Why are you quitting this task?</label>
						<!--- The task is to easy-->
						<!--- The task is to hard-->
						<!--- It is not clear to me what I need to do-->
						<!--- The tool does not work like I would expect-->
						<!--- Other, (provide textfield)-->
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="too easy">
								The task is too easy
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="too hard">
								The task is too hard
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="not clear">
								It is not clear to me what I need to do
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="tool doesn't work">
								The tool does not work like I would expect
							</label>
						</div>
						<div class="radio">
							<label>
								<input type="radio" name="quitReason" value="Other">
								Other (explained below)
							</label>
						</div>
						<fieldset class="form-group top-buffer-50">
							<label for="quitText">Do you have any feedback to improve this HIT?</label>
							<textarea class="form-control" id="quitText" rows="3"></textarea>
						</fieldset>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-danger disabled" disabled="true" id="quitSubmit">Quit this HIT</button>
				</div>
			</form>
				</div>
			</div>
		</div>
	</div>

	<style>
		.container-tool {
			margin-top: 60px;
		}

		.canvasContainer {
			opacity: 0.4;
			transition: opacity .13s ease-out;
		}
		
		.canvasContainer.focusedCanvas {
			opacity: 1;
		}

		canvas.canvas-sketch {
			display: block;
			box-shadow: 0px 16px 32px 0px rgba(0,0,0,0.04);
			border-radius: 5px;
		}

		.form-transparent {
			background-color: transparent;
			border: none;
			outline: none;
		}

		.canvas-forms {
			margin-top: 25px;
		}

		.form-name {
			font-size: 20px;
		}

		.form-description {
			font-size: 15px;
			line-height: 20px;
			height: 80px;
			resize: none;
		}
	</style>
</template>

<template name="decisionPointInformationPanel">
	<div class="row">
		<div class="col-md-12 col-lg-10 col-lg-offset-1">
			<p class="lead">
				MTurk CrowdDesign HIT<br><br>
			</p>
			<p><a data-toggle="modal" data-target="#finishModal" class="btn btn-success btn-continue">REVIEW AND FINISH</a></p>
			<h4>{{name}}<br></h4>
			<p>{{description}}</p>
			<p><span class="text-muted"><strong>REQUIREMENTS</strong></span><br>
				{{requirements}}</p>

			<!--modal for this button placed below-->
			<button class="btn btn-danger btn-continue top-buffer-50" data-toggle="modal" data-target="#quitModal">QUIT</button>

		</div>
	</div>
</template>