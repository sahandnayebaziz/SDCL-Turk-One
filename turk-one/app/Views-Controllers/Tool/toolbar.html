<template name="toolbar">
	<div id="toolbarContainer" class="md-fixed noselect animated fadeIn">
		<span class="buttonToolbar buttonColor" id="buttonBlack" data-color="#414141"></span>

		<!--<span class="buttonColor" id="buttonWhite" data-color="#FFFFFF"></span>-->
		<span class="buttonToolbar deselectedTool buttonColor" id="buttonBlue" data-color="#80D4FC"></span>
								<span class="buttonToolbar deselectedTool buttonColor" id="buttonGreen"
								      data-color="#A1F5AA"
								      href="#" data-trigger="manual" data-toggle="1"
								      title="select the colour of your brush"></span>

		<span class="buttonToolbar deselectedTool buttonColor" id="buttonRed" data-color="#F78479"></span>

		<span class="buttonToolbar deselectedTool buttonColor" id="buttonYellow" data-color="#FBDE9E"></span>

		<img src="/type.png" class="buttonToolbar deselectedTool" id="buttonText" href="#"
		     data-trigger="manual" data-toggle="2"
		     title="Add text to your sketch: click anywhere on the canvas to add, then click on the text to edit.">

		<img src="/rectangle.png" class="buttonToolbar deselectedTool" id="buttonRectangle" href="#"
		     data-trigger="manual" data-toggle="2"
		     title="Add a rectangle to your sketch: click anywhere on the canvas to add a rectangle, then click on the object to move it around">

		<img src="/circle.png" class="buttonToolbar deselectedTool" id="buttonCircle" href="#"
		     data-trigger="manual" data-toggle="2"
		     title="Add a circle to your sketch: click anywhere on the canvas to add a circle, then click on the text to edit."/>

							<span class="buttonToolbar deselectedTool" id="buttonMove" href="#"
							      data-trigger="manual" data-toggle="3"
							      title="With this tool you can move, resize or rotate every object on your canvas"></span>

		<img src="/send-front.png" class="buttonToolbar deselectedTool" id="buttonSendFront" href="#"
		     data-trigger="manual" data-toggle="2"
		     title="Click to make an object sit above all other objects">

		<img src="/send-back.png" class="buttonToolbar deselectedTool" id="buttonSendBack" href="#"
		     data-trigger="manual" data-toggle="2"
		     title="Click to make an object sit below all other objects."/>

							<span class="buttonToolbar deselectedTool" id="buttonEraser" href="#"
							      data-trigger="manual" data-toggle="4"
							      title="Erase: Click on object to delete or drag to select objects you want to delete, then click on the selected objects"></span>

		<img src="/undo-icon.png" class="buttonToolbar deselectedTool buttonHistory"
		     id="buttonUndo"
		     href="#" data-trigger="manual" data-toggle="5" title="Undo">

		<img src="/redo-icon.png" class="buttonToolbar deselectedTool buttonHistory"
		     id="buttonRedo"
		     href="#" data-trigger="manual" data-toggle="6" title="Redo">

							<span class=" buttonToolbar deselectedTool" id="toolbarTips" data-toggle="modal"
							      data-target="#tooltipModal">?</span>
	</div>
	<script>
		//TODO: BRING THESE STOP WATCHES BACK TO TOOL!
		// initialize stopwatch arrays
		interactionStopwatches = [];
		locationStopwatches = [];
		readingStopwatches = []; // these have a higher tolerance for inactivity (160 seconds instead of 10)

		// functions that operate on stopwatches in those arrays
		function resetInteractionTimers() {
			$.each(interactionStopwatches, function () {
				this.reset();
			});
		}
		function resetLocationTimers() {
			$.each(locationStopwatches, function () {
				this.reset();
			});
		}
		function resetReadingTimers() {
			$.each(readingStopwatches, function () {
				this.reset();
			});
		}
		function activateLocationTimers() {
			$.each(locationStopwatches, function () {
				this.start();
			});
		}

		// stopwatch running for canvas with focus
		stopwatchWithFocus = null;

		// stopwatch running for total time on tools page
		pageStopwatch = new Stopwatch();
		locationStopwatches.push(pageStopwatch);
		pageStopwatch.start();

		// stopwatch that will run when writing a name
		typingTimerName = new Stopwatch();
		interactionStopwatches.push(typingTimerName);

		// stopwatch that will run when writing an explanation
		typingTimerExplanation = new Stopwatch();
		interactionStopwatches.push(typingTimerExplanation);

		// initialize idle timers
		idleTime = 0;
		var idleInterval = setInterval(timerIncrement, 1000); // every second
		$(this).mousemove(function (e) {
			idleTime = 0;
		}); // reset the timer
		$(this).keypress(function (e) {
			idleTime = 0;
		});  // reset the timer
		function timerIncrement() {
			idleTime = idleTime + 1;
			if (idleTime <= 10) {
				activateLocationTimers();
			}
			if (idleTime > 10) { // after ten seconds
				resetInteractionTimers();
				resetLocationTimers();
			}
			if (idleTime > 160) { // after 2 minutes
				resetReadingTimers();
			}
		}

		// set up for canvases
		// this array will hold references to each Fabric canvas instance, and is looped through in the below toolbar
		// actions to 'broadcast' the toolbar selects across the canvases
		canvases = [];

		// focusedCanvas
		canvasWithFocus = null;

		// used for maintaing sanity while drawing straight or free-form lines
		isDrawing = false;

		// state object for undo/redo stacks
		canvasHistory = {};

		// focusedText?
		focusedText = false;

		// Set Black as default color in toolbar (set for each canvas at initialization in tool.html
		Session.set("currentColor", "#414141");
		$("#buttonBlack").addClass("selectedTool");

		// setting toolbar active tool
		function setSelectedTool(tool) {
			$(".selectedTool").removeClass("selectedTool").addClass("deselectedTool");
			$(tool).addClass("selectedTool");

			if (($(tool).attr("id") != "buttonEraser") && ($(tool).attr("id") != "buttonText")) {
				removeMouseDownEvents();
			}
		}

		// toolbar color clicked
		$(".buttonColor").click(function () {
			setSelectedTool(this);
			var colorChosen = this.getAttribute("data-color");

			Session.set("currentColor", colorChosen);
			$.each(canvases, function () {
				this.freeDrawingBrush.color = colorChosen;
				this.isDrawingMode = true;
			});

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Selecting a color',
				eventLabel: Session.get("ticket")
			});

		});

		// toolbar eraser clicked
		$("#buttonEraser").click(function () {
			setSelectedTool(this);
			enableEraser();

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Eraser',
				eventLabel: Session.get("ticket")
			});
		});
		function removeMouseDownEvents() {
			$.each(canvases, function () {
				this.off("mouse:down");
			});
		}
		function enableEraser() {
			$.each(canvases, function () {
				var canvas = this;

				canvas.isDrawingMode = false;
				canvas.on("mouse:down", function (e) {
					if (this.getActiveGroup()) {
						recordingStates = false;
						canvas.getActiveGroup().forEachObject(function (a) {
							canvas.remove(a);
						});
						canvas.discardActiveGroup();
						recordingStates = true;
					} else {
						canvas.remove(canvas.getActiveObject());
					}
					canvas.renderAll();
				});
			});
		}

		// toolbar move controls clicked
		$("#buttonMove").click(function () {
			setSelectedTool(this);

			$.each(canvases, function () {
				this.isDrawingMode = false;
			});

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Move Controls',
				eventLabel: Session.get("ticket")
			});
		})

		// this is an explicit mod of the above function that can be synthetically run from another click handler
		function simulateMoveClick() {
			setSelectedTool($("#buttonMove"));
			$.each(canvases, function () {
				this.isDrawingMode = false;
			});
		}

		// text button clicked
		$("#buttonText").click(function () {
			setSelectedTool(this);

			$.each(canvases, function () {
				this.isDrawingMode = false;
			});

			$.each(canvases, function () {
				this.on("mouse:down", function (e) {
					var locationOnThisCanvas = this.getPointer(event.e);
					this.add(new fabric.IText('Enter Text', {
						fontFamily: 'times black',
						left: locationOnThisCanvas.x,
						top: locationOnThisCanvas.y,
						fontSize: 16
					}));

					var newTextObject = this.item(this.getObjects().length - 1);
					this.setActiveObject(newTextObject);

					simulateMoveClick();
				});
			});

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Text',
				eventLabel: Session.get("ticket")
			});
		});

		// shape tools
		$("#buttonRectangle").click(function () {
			setSelectedTool(this);

			$.each(canvases, function () {
				this.isDrawingMode = false;
			});

			$.each(canvases, function () {
				this.on("mouse:down", function (e) {
					var locationOnThisCanvas = this.getPointer(event.e);
					this.add(new fabric.Rect({
						width: 200,
						height: 200,
						stroke: Session.get("currentColor"),
						fill: "transparent",
						opacity: 1,
						strokeWidth: 2,
						left: locationOnThisCanvas.x,
						top: locationOnThisCanvas.y,
					}));
					var newRectObject = this.item(this.getObjects().length - 1);
					this.setActiveObject(newRectObject);

					simulateMoveClick();
				});
			});

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Rectangle',
				eventLabel: Session.get("ticket")
			});
		});

		$("#buttonCircle").click(function () {
			setSelectedTool(this);

			$.each(canvases, function () {
				this.isDrawingMode = false;
			});

			$.each(canvases, function () {
				this.on("mouse:down", function (e) {
					var locationOnThisCanvas = this.getPointer(event.e);
					this.add(new fabric.Circle({
						radius: 100,
						width: 200,
						height: 200,
						stroke: Session.get("currentColor"),
						fill: "transparent",
						opacity: 1,
						strokeWidth: 2,
						left: locationOnThisCanvas.x,
						top: locationOnThisCanvas.y,
					}));
					var newRectObject = this.item(this.getObjects().length - 1);
					this.setActiveObject(newRectObject);

					simulateMoveClick();
				});
			});

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Circle',
				eventLabel: Session.get("ticket")
			});
		});

		$("#buttonSendFront").click(function () {

			if (canvasWithFocus.getActiveObject()) {
				var target = canvasWithFocus.getActiveObject();
				canvasWithFocus.bringToFront(target);
				canvasWithFocus.deactivateAll();
				canvasWithFocus.renderAll();
			}

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Send front',
				eventLabel: Session.get("ticket")
			});
		});

		$("#buttonSendBack").click(function () {
			if (canvasWithFocus.getActiveObject()) {
				var target = canvasWithFocus.getActiveObject();
				canvasWithFocus.sendToBack(target);
				canvasWithFocus.deactivateAll();
				canvasWithFocus.renderAll();
			}

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Send back',
				eventLabel: Session.get("ticket")
			});
		});


		// UNDO AND REDO
		$("#buttonUndo").click(function () {

			var index = canvasWithFocus.CDIndex;
			var back = canvasHistory[index].backStates;

			if (back.length > 1) {
				canvasHistory[index].recording = false;
				var fromState = back.pop();
				canvasHistory[index].forwardStates.push(fromState);
				var toState = back[back.length - 1];
				canvasWithFocus.loadFromJSON(toState);
				canvasWithFocus.renderAll();
				canvasHistory[index].recording = true;
			}

			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Undo',
				eventLabel: Session.get("ticket")
			});
		});
		$("#buttonRedo").click(function () {
			var index = canvasWithFocus.CDIndex;
			var forward = canvasHistory[index].forwardStates;

			if (forward.length > 0) {
				canvasHistory[index].recording = false;
				var toState = forward.pop();
				canvasHistory[index].backStates.push(toState);

				canvasWithFocus.loadFromJSON(toState);
				canvasWithFocus.renderAll();
				canvasHistory[index].recording = true;
			}
			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Redo',
				eventLabel: Session.get("ticket")
			});
		});

		$("#toolbarTips").click(function () {
			ga('send', {
				hitType: 'event',
				eventCategory: 'Toolbar',
				eventAction: 'Toolbar Tips',
				eventLabel: Session.get("ticket")
			});
		});

		// guessing focus
		function findFocus() {

			var scrollPosition = $(window).scrollTop();
			var focusDistance = 9999;
			var focusGuess = null;
			var focusGuessIndex = 0;

			$.each($(".canvasContainer"), function () {
				var positionAtTopOfCanvas = $(this).offset().top;
				var distanceFromScrollPosition = Math.abs(scrollPosition - positionAtTopOfCanvas);
				if ((scrollPosition < positionAtTopOfCanvas + 250) && (distanceFromScrollPosition < focusDistance)) {
					focusDistance = distanceFromScrollPosition;
					focusGuess = this;
				}
			});

			$.each($(".canvasContainer"), function () {
				if (this == focusGuess) {
					$(this).removeClass("unfocusedCanvas");
					$(this).addClass("focusedCanvas");
					focusGuessIndex = parseInt($(this).attr("data-CDIndex"));
				} else {
					$(this).removeClass("focusedCanvas");
					$(this).addClass("unfocusedCanvas");
				}
			});

			$.each(canvases, function () {
				if (this.CDIndex == focusGuessIndex) {
					canvasWithFocus = this;
				}
			});

			$.each(interactionStopwatches, function () {
				if (this.identifier == focusGuessIndex) {
					this.start();
					stopwatchWithFocus = this;
				} else {
					this.stop();
					this.reset();
				}
			});
		}

		// attach focus guessing to window scrolling
		$(window).scroll(findFocus);

		// provide method for forcing focus
		forceFocus = function (index) {

			$.each($(".canvasContainer"), function () {
				if (parseInt($(this).attr("data-cdindex")) == index) {
					$(this).removeClass("unfocusedCanvas");
					$(this).addClass("focusedCanvas");
				} else {
					$(this).removeClass("focusedCanvas");
					$(this).addClass("unfocusedCanvas");
				}
			});

			$.each(canvases, function () {
				if (this.CDIndex == index) {
					canvasWithFocus = this;
				}

			});

			$.each(interactionStopwatches, function () {
				if (this.identifier == index) {
					this.start();
					stopwatchWithFocus = this;
				} else {
					this.stop();
				}
			});

		};

		$("#col-sketch").on("mousedown", ".canvasContainer", function () {
			var index = parseInt($(this).attr("data-cdindex"));
			forceFocus(index);
		});


	</script>
</template>